# ConfigManager 模块

## 概述

ConfigManager 是 EdgeStream 系统的配置管理核心模块，基于 Apache NiFi 的 ConfigManager 设计理念，提供了完整的配置管理解决方案。该模块负责全系统配置的加载、解析、加密、更新与分发，确保配置的安全、灵活和可控。

## 核心功能

### 1. 中心化配置管理
- 支持多种配置文件格式（Properties、YAML、JSON、XML）
- 环境变量自动注入
- 配置缓存和持久化
- 配置层次结构管理

### 2. 敏感数据加密
- AES-GCM 256位加密算法
- 密钥管理和存储
- 自动加密/解密敏感属性
- 支持多种加密算法扩展

### 3. 环境变量与表达式注入
- 环境变量动态解析
- 表达式语言支持
- 变量解析器扩展机制
- 模板引擎集成

### 4. 运行时配置修改
- 动态配置更新
- 热重载支持
- 配置变更通知
- 优雅重启机制

### 5. 配置验证与校验
- 多种验证策略（严格、宽松、忽略）
- 可扩展的验证器接口
- 配置历史管理
- 配置回滚功能

## 模块结构

```
ConfigManager/
├── config_manager.go              # 主配置管理器接口和实现
├── validation.go                  # 配置验证器和历史管理
├── examples.go                    # 使用示例
├── README.md                      # 本文档
├── SensitivePropertyEncryptor/    # 敏感属性加密器
│   └── sensitive_property_provider.go
├── ConfigLoader/                  # 配置文件加载器
│   └── config_file_manager.go
├── EnvironmentVariableInjector/   # 环境变量注入器
│   └── environment_injector.go
└── ConfigChangeNotifier/          # 配置变更通知器
    └── configuration_change_manager.go
```

## 快速开始

### 基本使用

```go
package main

import (
    "fmt"
    "log"
    "edge-stream/internal/ConfigManager"
    "edge-stream/internal/ConfigManager/SensitivePropertyEncryptor"
)

func main() {
    // 创建配置管理器
    configManager := ConfigManager.NewStandardConfigManager()
    
    // 创建密钥管理器
    keyManager := SensitivePropertyEncryptor.NewKeyStoreManager("keystore.p12", "nifi-key", "nifi-secret")
    secretKey, err := keyManager.GenerateOrLoadKey()
    if err != nil {
        log.Fatalf("生成密钥失败: %v", err)
    }
    
    // 设置敏感属性提供者
    sensitiveProvider := SensitivePropertyEncryptor.NewAESSensitivePropertyProvider(secretKey)
    configManager.SetSensitivePropertyProvider(sensitiveProvider)
    
    // 设置配置属性
    err = configManager.SetProperty("nifi.web.http.port", "8080", false)
    if err != nil {
        log.Printf("设置HTTP端口失败: %v", err)
    }
    
    // 设置敏感配置
    err = configManager.SetProperty("db.password", "secret123", true)
    if err != nil {
        log.Printf("设置数据库密码失败: %v", err)
    }
    
    // 获取配置
    httpPort, err := configManager.GetProperty("nifi.web.http.port")
    if err != nil {
        log.Printf("获取HTTP端口失败: %v", err)
    } else {
        fmt.Printf("HTTP端口: %s\n", httpPort)
    }
}
```

### 配置验证

```go
// 注册配置验证器
portValidator := ConfigManager.NewPortRangeValidator(1024, 65535)
configManager.RegisterValidator(portValidator)

dbValidator := ConfigManager.NewDatabaseConfigValidator()
configManager.RegisterValidator(dbValidator)

// 验证配置
result, err := configManager.ValidateConfiguration()
if err != nil {
    log.Printf("配置验证失败: %v", err)
} else {
    if result.IsValid {
        fmt.Println("配置验证通过")
    } else {
        fmt.Printf("配置验证失败: %s\n", result.GetErrors())
    }
}
```

### 配置变更监听

```go
// 创建配置变更监听器
listener := &MyConfigChangeListener{}
configManager.AddConfigurationChangeListener(listener)

// 实现监听器接口
type MyConfigChangeListener struct{}

func (mcl *MyConfigChangeListener) OnConfigurationChanged(event *ConfigChangeNotifier.ConfigurationChangeEvent) {
    fmt.Printf("配置变更: %s = %s\n", event.Key, event.Value)
}
```

### 环境变量注入

```go
// 创建环境变量注入器
envInjector := EnvironmentVariableInjector.NewEnvironmentInjector()

// 处理包含环境变量的配置值
configValue := "jdbc:postgresql://${ENV:NIFI_DB_HOST}:${ENV:NIFI_DB_PORT}/nifi"
processedValue := envInjector.InjectEnvironmentVariables(configValue)
fmt.Printf("处理后: %s\n", processedValue)
```

## 配置文件格式

### Properties 格式
```properties
# NiFi Configuration File
# Generated by ConfigManager

nifi.web.http.port=8080
nifi.web.https.port=8443
db.url=jdbc:postgresql://localhost:5432/nifi
db.username=nifi
db.password=ENC{encrypted_password}
```

### YAML 格式
```yaml
# NiFi Configuration File (YAML)
nifi:
  web:
    http:
      port: 8080
    https:
      port: 8443
db:
  url: jdbc:postgresql://localhost:5432/nifi
  username: nifi
  password: ENC{encrypted_password}
```

### JSON 格式
```json
{
  "nifi.web.http.port": "8080",
  "nifi.web.https.port": "8443",
  "db.url": "jdbc:postgresql://localhost:5432/nifi",
  "db.username": "nifi",
  "db.password": "ENC{encrypted_password}"
}
```

## 配置验证器

### 内置验证器

1. **PortRangeValidator**: 验证端口范围
```go
portValidator := ConfigManager.NewPortRangeValidator(1024, 65535)
```

2. **DatabaseConfigValidator**: 验证数据库配置
```go
dbValidator := ConfigManager.NewDatabaseConfigValidator()
```

### 自定义验证器

```go
type CustomValidator struct{}

func (cv *CustomValidator) Validate(configMap ConfigManager.ConfigMap) (*ConfigManager.ValidationResult, error) {
    result := ConfigManager.NewValidationResult()
    
    // 验证逻辑
    value, exists := configMap.Get("custom.property")
    if exists && value == "" {
        result.AddError("自定义属性不能为空")
    }
    
    return result, nil
}

// 注册自定义验证器
configManager.RegisterValidator(&CustomValidator{})
```

## 加密机制

### AES-GCM 加密

```go
// 创建密钥
keyManager := SensitivePropertyEncryptor.NewKeyStoreManager("keystore.p12", "nifi-key", "nifi-secret")
secretKey, err := keyManager.GenerateOrLoadKey()

// 创建加密提供者
provider := SensitivePropertyEncryptor.NewAESSensitivePropertyProvider(secretKey)

// 加密
encrypted, err := provider.Encrypt("plaintext")
if err != nil {
    log.Printf("加密失败: %v", err)
}

// 解密
decrypted, err := provider.Decrypt(encrypted)
if err != nil {
    log.Printf("解密失败: %v", err)
}
```

## 配置历史管理

```go
// 创建历史管理器
historyManager := ConfigManager.NewConfigHistoryManager()

// 记录配置快照
historyManager.RecordConfigurationSnapshot(configMap)

// 获取配置历史
history := historyManager.GetConfigurationHistory()

// 回滚到上一个配置
previousConfig, err := historyManager.RollbackToPreviousConfiguration()
```

## 热重载

```go
// 创建热重载管理器
hotReloadManager := ConfigChangeNotifier.NewHotReloadManager(configManager)

// 重载处理器配置
err := hotReloadManager.ReloadProcessorConfiguration(processor)
```

## 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 配置加载延迟 | <50ms | 配置文件加载耗时 |
| 加密开销 | <20ms | 敏感属性加密耗时 |
| 配置变更通知 | <10ms | 配置变更通知耗时 |
| 配置验证性能 | <100ms | 配置验证耗时 |

## 最佳实践

### 1. 配置管理
- 使用环境变量进行环境特定的配置
- 对敏感信息使用加密存储
- 定期备份配置文件
- 使用版本控制管理配置变更

### 2. 验证策略
- 生产环境使用严格验证策略
- 开发环境可以使用宽松验证策略
- 自定义验证器处理业务特定的验证逻辑

### 3. 安全考虑
- 定期轮换加密密钥
- 限制配置文件的访问权限
- 审计配置变更历史
- 使用安全的密钥存储机制

### 4. 性能优化
- 合理设置配置缓存大小
- 避免频繁的配置重载
- 使用异步通知机制
- 优化验证器性能

## 扩展开发

### 添加新的配置文件格式

```go
// 实现 ConfigFileManager 接口
type CustomConfigFileManager struct{}

func (ccfm *CustomConfigFileManager) LoadConfigFile(configPath string) (map[string]string, error) {
    // 实现自定义格式的加载逻辑
}

func (ccfm *CustomConfigFileManager) SaveConfigFile(properties map[string]string, configPath string) error {
    // 实现自定义格式的保存逻辑
}
```

### 添加新的加密算法

```go
// 实现 SensitivePropertyProvider 接口
type CustomEncryptionProvider struct{}

func (cep *CustomEncryptionProvider) Encrypt(plaintext string) (string, error) {
    // 实现自定义加密算法
}

func (cep *CustomEncryptionProvider) Decrypt(ciphertext string) (string, error) {
    // 实现自定义解密算法
}

func (cep *CustomEncryptionProvider) GetAlgorithm() string {
    return "CUSTOM_ALGORITHM"
}
```

## 故障排除

### 常见问题

1. **配置加载失败**
   - 检查配置文件路径是否正确
   - 确认文件格式是否支持
   - 验证文件权限

2. **加密/解密失败**
   - 检查密钥是否正确
   - 确认加密算法是否匹配
   - 验证密钥存储路径

3. **配置验证失败**
   - 检查验证器配置
   - 确认配置值格式
   - 查看验证错误信息

4. **热重载失败**
   - 检查处理器状态
   - 确认配置变更是否兼容
   - 查看重载日志

### 调试技巧

1. 启用详细日志输出
2. 使用配置历史查看变更
3. 检查环境变量设置
4. 验证文件权限和路径

## 版本历史

- **v1.0.0**: 初始版本，支持基本配置管理功能
- **v1.1.0**: 添加环境变量注入和表达式语言支持
- **v1.2.0**: 增强加密机制和密钥管理
- **v1.3.0**: 添加配置历史管理和回滚功能

## 贡献指南

欢迎贡献代码和提出建议！请遵循以下步骤：

1. Fork 项目
2. 创建功能分支
3. 提交更改
4. 创建 Pull Request

## 许可证

本项目采用 MIT 许可证。详见 LICENSE 文件。 