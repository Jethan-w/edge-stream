# EdgeStream 综合示例架构图

## 系统架构概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           EdgeStream 综合示例架构                            │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   数据源层       │    │   处理层         │    │   接收层         │
│   (Source)      │    │   (Pipeline)    │    │   (Sink)        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  File Source    │    │  Data Pipeline  │    │  File Sink      │
│  Kafka Source   │    │  Processors     │    │  DB Sink        │
│  HTTP Source    │    │  Window Manager │    │  Kafka Sink     │
└─────────────────┘    └─────────────────┘    └─────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              核心服务层                                      │
├─────────────────┬─────────────────┬─────────────────┬─────────────────────┤
│ ConfigManager   │ ConnectorRegistry│ MetricCollector │ StateManager        │
│ 配置管理        │ 连接器注册表     │ 指标收集        │ 状态管理            │
└─────────────────┴─────────────────┴─────────────────┴─────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              流引擎层                                        │
│                           StreamEngine                                      │
│  - 线程池管理                                                                │
│  - 调度管理                                                                  │
│  - 背压管理                                                                  │
│  - 集群协调                                                                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 数据流架构

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  数据源      │───▶│  FlowFile   │───▶│  处理器     │───▶│  数据接收器  │
│  (Source)   │    │  创建       │    │  (Processor)│    │  (Sink)     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 协议适配器   │    │ 属性设置    │    │ 窗口聚合     │    │ 目标适配器   │
│ 安全接收器   │    │ 内容处理    │    │ 语义提取     │    │ 重试管理     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 组件交互时序图

```
时间轴 ──────────────────────────────────────────────────────────────────────▶

ConfigManager    ConnectorRegistry  MetricCollector  StateManager  StreamEngine
     │                   │                   │              │              │
     │───初始化──────────▶│                   │              │              │
     │                   │───注册连接器──────▶│              │              │
     │                   │                   │───启动收集───▶│              │
     │                   │                   │              │───初始化─────▶│
     │                   │                   │              │              │
     │───加载配置────────▶│                   │              │              │
     │                   │                   │              │              │
     │                   │                   │              │              │───启动引擎
     │                   │                   │              │              │
     │                   │                   │              │              │───调度处理器
     │                   │                   │              │              │
     │                   │                   │───记录指标───▶│              │
     │                   │                   │              │───保存状态───▶│
     │                   │                   │              │              │
     │                   │                   │              │              │───停止引擎
     │                   │                   │              │              │
     │                   │                   │───生成报告───▶│              │
```

## 详细组件关系

### 1. 配置管理层 (ConfigManager)
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ConfigManager                                     │
├─────────────────┬─────────────────┬─────────────────┬─────────────────────┤
│ ConfigFileManager│ Configuration   │ Environment     │ Validation          │
│ 配置文件管理     │ ChangeManager   │ Injector        │ 配置验证            │
│                 │ 配置变更管理     │ 环境变量注入     │                     │
└─────────────────┴─────────────────┴─────────────────┴─────────────────────┘
```

### 2. 连接器注册表 (ConnectorRegistry)
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ConnectorRegistry                                    │
├─────────────────┬─────────────────┬─────────────────┬─────────────────────┤
│ BundleRepository│ VersionController│ ExtensionMapping│ SecurityValidator   │
│ Bundle仓库      │ 版本控制器       │ 扩展映射        │ 安全验证器          │
└─────────────────┴─────────────────┴─────────────────┴─────────────────────┘
```

### 3. 指标收集器 (MetricCollector)
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          MetricCollector                                    │
├─────────────────┬─────────────────┬─────────────────┬─────────────────────┤
│ MetricsAggregator│ MetricsExporter │ MetricsRecorder │ LineageTracker      │
│ 指标聚合器       │ 指标导出器       │ 指标记录器       │ 血缘跟踪器          │
└─────────────────┴─────────────────┴─────────────────┴─────────────────────┘
```

### 4. 状态管理器 (StateManager)
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           StateManager                                      │
├─────────────────┬─────────────────┬─────────────────┬─────────────────────┤
│ LocalState      │ DistributedState│ StateRecovery   │ StateSynchronizer   │
│ Provider        │ Provider        │ Manager         │ 状态同步器          │
│ 本地状态提供者   │ 分布式状态提供者 │ 状态恢复管理器   │                     │
└─────────────────┴─────────────────┴─────────────────┴─────────────────────┘
```

### 5. 流引擎 (StreamEngine)
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           StreamEngine                                      │
├─────────────────┬─────────────────┬─────────────────┬─────────────────────┤
│ ThreadPool      │ Scheduler       │ Backpressure    │ ClusterCoordinator  │
│ Manager         │ 调度器          │ Manager         │ 集群协调器          │
│ 线程池管理器     │                 │ 背压管理器       │                     │
└─────────────────┴─────────────────┴─────────────────┴─────────────────────┘
```

### 6. 窗口管理器 (WindowManager)
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           WindowManager                                     │
├─────────────────┬─────────────────┬─────────────────┬─────────────────────┤
│ WindowDefiner   │ Timestamp       │ WindowState     │ WindowTrigger       │
│ 窗口定义器       │ Extractor       │ Manager         │ 窗口触发器          │
│                 │ 时间戳提取器     │ 窗口状态管理器   │                     │
└─────────────────┴─────────────────┴─────────────────┴─────────────────────┘
```

## 数据流处理流程

### 1. 数据输入阶段
```
文件系统/Kafka/HTTP → 协议适配器 → 安全接收器 → FlowFile创建
```

### 2. 数据处理阶段
```
FlowFile → 数据转换 → 语义提取 → 窗口聚合 → 处理完成
```

### 3. 数据输出阶段
```
处理完成 → 目标适配器 → 重试管理 → 错误路由 → 数据输出
```

### 4. 监控反馈阶段
```
各阶段 → 指标收集 → 状态保存 → 血缘跟踪 → 监控报告
```

## 配置依赖关系

```
ConfigManager ←─── 所有组件
     │
     ├─── ConnectorRegistry (连接器配置)
     ├─── MetricCollector (指标配置)
     ├─── StateManager (状态配置)
     ├─── StreamEngine (引擎配置)
     ├─── Source (数据源配置)
     ├─── Pipeline (管道配置)
     └─── Sink (接收器配置)
```

## 错误处理机制

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  错误发生    │───▶│ 错误处理器   │───▶│ 错误路由     │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 重试机制     │    │ 降级处理     │    │ 错误报告     │
└─────────────┘    └─────────────┘    └─────────────┘
```

## 性能监控点

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 吞吐量监控   │    │ 延迟监控     │    │ 错误率监控   │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 资源使用监控 │    │ 队列深度监控 │    │ 处理时间监控 │
└─────────────┘    └─────────────┘    └─────────────┘
```

这个架构图展示了 EdgeStream 综合示例中所有组件的交互关系和数据流向，帮助理解整个系统的设计理念和实现方式。 